name: Validate Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main

jobs:
  pr-structure-validation:
    name: Validate PR Structure
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Title
        run: |
          title="${{ github.event.pull_request.title }}"
          title_regex="^(feat|chore|fix|test|docs|refactor|style|perf|revert):"
          if [[ ! "$title" =~ $title_regex ]]; then
            echo "❌ PR title must start with a valid prefix (e.g., feat, chore, fix, test, etc.) followed by a colon."
            exit 1
          fi
          echo "✅ PR title is valid."

      - name: Check Branch Name
        run: |
          branch="${{ github.event.pull_request.head.ref }}"
          branch_regex="^(feat|chore|fix|test|docs|refactor|style|perf|revert)/[a-z0-9-]+$"
          if [[ ! "$branch" =~ $branch_regex ]]; then
            echo "❌ Branch name must start with a valid prefix (e.g., feat/, chore/, fix/, etc.) followed by a descriptive name."
            exit 1
          fi
          echo "✅ Branch name is valid."
      
      - name: Check PR Description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          MIN_WORDS=10
          count=$(echo "$PR_BODY" | wc -w)
          if [ "$count" -lt "$MIN_WORDS" ]; then
            echo "❌ PR description is too short ($count words). Please provide a more detailed description (at least $MIN_WORDS words)."
            exit 1
          fi
          echo "✅ PR description is valid."
        
  static-code-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint radon
      
      - name: Code smells/style check
        run: |
          pylint --disable=import-error $(git ls-files '*.py')
      
      - name: Code complexity check
        run: |
          radon cc -a $(git ls-files '*.py') > cc_report.txt
          cat cc_report.txt
          if grep -qE ' - [CDEF]$' cc_report.txt; then
            echo "❌ Complexity too high!"
            exit 1
          fi
          echo "✅ Complexity OK"
  
  requirements-checks:
    name: Requirements Checks
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pipreqs
        run: pip install pipreqs

      - name: Check requirements.txt files
        run: |
          set -e

          for dir in $(find . -type f -name "*.py" -exec dirname {} \; | sort -u); do
            pipreqs "$dir" --force --savepath "$dir/pipreqs-requirements.txt"

            # Check if pipreqs generated an empty requirements file. In such case,
            # the Python module only has standard library dependencies and doesn't
            # need a requirements.txt file.
            if ! grep -q '[^[:space:]]' "$dir/pipreqs-requirements.txt"; then
              echo "ℹ️  $dir has no external dependencies, skipping requirements.txt check."
              continue
            fi

            sort "$dir/pipreqs-requirements.txt" > "$dir/pipreqs-requirements-sorted.txt"
            sed -i 's/==.*//' "$dir/pipreqs-requirements-sorted.txt"

            if [ ! -f "$dir/requirements.txt" ]; then
              echo "❌ Python module $dir does not have a requirements.txt file."
              echo "Python source code should be organized in modules (directories), each with its own requirements.txt file."
              exit 1
            fi

            sort "$dir/requirements.txt" > "$dir/requirements-sorted.txt"
            sed -i 's/==.*//' "$dir/requirements-sorted.txt"

            # Enforce that at least the requirements listed by pipreqs are present in requirements.txt.
            missing=$(comm -23 "$dir/pipreqs-requirements-sorted.txt" "$dir/requirements-sorted.txt" | grep . || true)
            if [ -n "$missing" ]; then
              echo "❌ $dir/requirements.txt is not up-to-date with the imported environment."
              echo "Missing: $missing"
              echo "Please run 'pipreqs . --force' in the module directory to update it."
              exit 1
            fi
            
            echo "✅ $dir/requirements.txt is up-to-date with the imported environment."
          done